name: Django Tests

on:
  push:
    branches: [main, develop, feature_CI/CD_GitHub_Actions]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      run: pip install poetry
    
    - name: Install dependencies
      run: poetry install
    
    - name: Run Django tests with SQLite
      env:
        DJANGO_SETTINGS_MODULE: config.test_settings
        SECRET_KEY: ${{ secrets.SECRET_KEY || 'test-secret-key' }}
      run: |
        # Создаем тестовые настройки если нет
        if [ ! -f "config/test_settings.py" ]; then
          cat > config/test_settings.py << 'EOT'
from .settings import *
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': ':memory:',
    }
}
EOT
        fi
        
        # Запускаем тесты
        poetry run python manage.py test tests/ --verbosity=2
    
    - name: Run basic Django check
      run: |
        # Проверяем что Django работает
        poetry run python -c "
        import os
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
        import django
        django.setup()
        from django.conf import settings
        print(f'Django {django.__version__} loaded successfully')
        print(f'SECRET_KEY: {settings.SECRET_KEY[:10]}...')
        "
    
    - name: Check code quality
      run: |
        # Простая проверка Python файлов
        poetry run python -m py_compile config/settings.py config/urls.py config/wsgi.py manage.py
    
    - name: Run custom tests
      run: |
        if [ -f "tests/test_ci.py" ]; then
          poetry run python tests/test_ci.py
        fi
