name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature_CI/CD_GitHub_Actions]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'poetry'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: poetry install
    
    - name: Create test settings
      run: |
        cat > config/test_settings.py << 'EOT'
from .settings import *

# –ò—Å–ø–æ–ª—å–∑—É–µ–º SQLite –¥–ª—è —Ç–µ—Å—Ç–æ–≤
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': ':memory:',
    }
}

# –£—Å–∫–æ—Ä—è–µ–º —Ç–µ—Å—Ç—ã
PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.MD5PasswordHasher',
]

# –û—Ç–∫–ª—é—á–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
MIGRATION_MODULES = {
    'auth': None,
    'contenttypes': None,
    'sessions': None,
}

# –û—Ç–∫–ª—é—á–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.dummy.DummyCache',
    }
}

# –û—Ç–∫–ª—é—á–∞–µ–º Celery –¥–ª—è —Ç–µ—Å—Ç–æ–≤
CELERY_TASK_ALWAYS_EAGER = True
CELERY_TASK_EAGER_PROPAGATES = True
EOT
    
    - name: Run Django tests
      env:
        DJANGO_SETTINGS_MODULE: config.test_settings
        SECRET_KEY: ${{ secrets.SECRET_KEY || 'test-secret-key-for-ci' }}
      run: |
        poetry run python manage.py test tests/ --verbosity=2
    
    - name: Run pytest
      env:
        DJANGO_SETTINGS_MODULE: config.test_settings
      run: |
        poetry run python -m pytest tests/ -v
    
    - name: Check Django deployment settings
      env:
        DJANGO_SETTINGS_MODULE: config.settings
        SECRET_KEY: ${{ secrets.SECRET_KEY || 'test-secret-key-for-ci' }}
      run: |
        poetry run python manage.py check --deploy 2>&1 | head -50 || echo "Deploy check completed"
    
    - name: Verify Dockerfile
      run: |
        if [ -f "Dockerfile" ]; then
          echo "‚úÖ Dockerfile exists"
          docker build --pull --rm -f "Dockerfile" -t docker-9:test "." || echo "Docker build check"
        else
          echo "‚ö† No Dockerfile found"
        fi
    
    - name: Verify docker-compose
      run: |
        if [ -f "docker-compose.yaml" ]; then
          echo "‚úÖ docker-compose.yaml exists"
          docker-compose -f docker-compose.yaml config || echo "docker-compose config check"
        else
          echo "‚ö† No docker-compose.yaml found"
        fi

  lint:
    runs-on: ubuntu-latest
    needs: test
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install linters
      run: |
        pip install black flake8 isort
    
    - name: Check Python syntax
      run: |
        python -m py_compile config/settings.py config/urls.py config/wsgi.py manage.py 2>&1 || echo "Syntax check"
    
    - name: Check imports with isort
      run: |
        isort --check-only --diff . 2>&1 | head -50 || echo "Import check"
    
    - name: Check code style with black
      run: |
        black --check --diff . 2>&1 | head -50 || echo "Code style check"
    
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics 2>&1 | head -50 || echo "Flake8 check"

  deploy-check:
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy readiness check
      run: |
        echo "üöÄ Ready for deployment!"
        echo "Branch: ${{ github.ref }}"
        echo "To deploy, configure SSH secrets and uncomment deploy steps"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
        echo "Required files check:"
        [ -f "Dockerfile" ] && echo "‚úÖ Dockerfile" || echo "‚ùå Missing Dockerfile"
        [ -f "docker-compose.yaml" ] && echo "‚úÖ docker-compose.yaml" || echo "‚ùå Missing docker-compose.yaml"
        [ -f ".env.example" ] && echo "‚úÖ .env.example" || echo "‚ùå Missing .env.example"
        [ -f "pyproject.toml" ] && echo "‚úÖ pyproject.toml" || echo "‚ùå Missing pyproject.toml"
        
        echo ""
        echo "üìã Next steps:"
        echo "1. Add SSH_PRIVATE_KEY to GitHub Secrets"
        echo "2. Add SERVER_HOST and SERVER_USER secrets"
        echo "3. Uncomment deploy steps in workflow"
