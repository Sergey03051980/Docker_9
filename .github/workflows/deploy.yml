name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Позволяет запускать вручную

jobs:
  test:
    runs-on: ubuntu-latest
    
    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY || 'test-secret-key-for-ci' }}
      DEBUG: "False"
      DJANGO_SETTINGS_MODULE: "config.test_settings"
      PYTHONPATH: "${{ github.workspace }}"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run migrations
      run: |
        python manage.py makemigrations --check --dry-run
        python manage.py migrate

    - name: Run Django tests
      run: |
        python manage.py test --verbosity=2 --failfast

    - name: Run pytest
      run: |
        pytest -v --tb=short

  deploy:
    runs-on: ubuntu-latest
    needs: test  # Запускать только после успешных тестов
    if: github.ref == 'refs/heads/main'  # Только для main ветки
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Simulate deployment (no server configured)
      if: ${{ !secrets.SERVER_HOST }}
      run: |
        echo "⚠️  No server configured - running simulation"
        echo "To enable real deployment, add SERVER_HOST, SERVER_USER, and SSH_PRIVATE_KEY secrets"
        ./scripts/simulate_deploy.sh
        
    - name: Real deployment to server
      if: ${{ secrets.SERVER_HOST && secrets.SERVER_USER && secrets.SSH_PRIVATE_KEY }}
      uses: appleboy/ssh-action@v0.1.5
      env:
        DEPLOY_MESSAGE: "Deploying commit ${{ github.sha }} to production"
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "$DEPLOY_MESSAGE"
          echo "======================================"
          
          # Переходим в директорию проекта
          cd /opt/docker-9
          
          # Обновляем код из репозитория
          echo "Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          # Активируем виртуальное окружение
          echo "Activating virtual environment..."
          source venv/bin/activate
          
          # Обновляем зависимости
          echo "Installing dependencies..."
          pip install -r requirements.txt
          
          # Применяем миграции
          echo "Running migrations..."
          python manage.py migrate
          
          # Собираем статические файлы
          echo "Collecting static files..."
          python manage.py collectstatic --noinput --clear
          
          # Перезапускаем сервисы
          echo "Restarting services..."
          sudo systemctl restart gunicorn
          sudo systemctl reload nginx
          
          # Проверяем статус
          echo "Checking service status..."
          sudo systemctl status gunicorn --no-pager
          
          echo "======================================"
          echo "✅ Deployment completed successfully!"
          echo "Application is live at: http://${{ secrets.SERVER_HOST }}"
          
    - name: Send deployment summary
      if: always()
      run: |
        echo "=== Deployment Summary ==="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Actor: ${{ github.actor }}"
        echo "Event: ${{ github.event_name }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Job Status: ${{ job.status }}"
        echo ""
        
        if [ "${{ secrets.SERVER_HOST }}" == "" ]; then
          echo "ℹ️  Real deployment disabled - no server secrets configured"
          echo "To enable real deployment, add:"
          echo "  - SERVER_HOST"
          echo "  - SERVER_USER" 
          echo "  - SSH_PRIVATE_KEY"
          echo ""
          echo "See DEPLOYMENT_GUIDE.md for setup instructions"
        else
          echo "✅ Real deployment enabled"
          echo "Server: ${{ secrets.SERVER_HOST }}"
        fi
